<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>每日飲水記錄器 - 會員版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 引入 Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* 樣式設定 (保持美觀與響應式) */
        :root { --primary: #3498db; --bg: #f4f7f6; --white: #fff; --text: #333; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; display: flex; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: var(--white); width: 100%; max-width: 400px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 30px; position: relative; }
        
        /* 登入/註冊畫面 */
        .auth-box { text-align: center; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: #666; font-size: 0.9rem; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #2980b9; }
        .link { color: var(--primary); cursor: pointer; margin-top: 15px; display: block; font-size: 0.9rem; }
        .error { color: #e74c3c; font-size: 0.9rem; margin-bottom: 10px; min-height: 20px; }

        /* 主應用畫面 */
        #app-screen { display: none; }
        header { text-align: center; margin-bottom: 20px; position: relative; }
        .logout-btn { position: absolute; top: -10px; right: -10px; background: none; border: none; color: #999; cursor: pointer; }
        
        .progress-circle { width: 160px; height: 160px; background: #e0f7fa; border-radius: 50%; margin: 0 auto 20px; position: relative; overflow: hidden; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(52,152,219,0.2); display: flex; justify-content: center; align-items: center; }
        .wave { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--primary); transition: height 0.5s; opacity: 0.8; z-index: 1; }
        .percentage { position: relative; z-index: 2; font-size: 2.5rem; font-weight: bold; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn-add { background: #e3f2fd; color: var(--primary); }
        .history-list { list-style: none; padding: 0; margin-top: 20px; max-height: 200px; overflow-y: auto; border-top: 1px solid #eee; }
        .history-list li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f9f9f9; font-size: 0.9rem; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <!-- 1. 登入區塊 -->
    <div id="auth-screen" class="auth-box">
        <h2 id="auth-title">會員登入</h2>
        <div class="input-group">
            <label>電子郵件</label>
            <input type="email" id="email" placeholder="name@example.com">
        </div>
        <div class="input-group">
            <label>密碼</label>
            <input type="password" id="password" placeholder="至少 6 位數">
        </div>
        <div id="auth-msg" class="error"></div>
        <button class="btn btn-primary" onclick="handleAuth()" id="auth-btn">登入</button>
        <span class="link" onclick="toggleAuth()" id="auth-toggle">沒有帳號？去註冊</span>
    </div>

    <!-- 2. 主程式區塊 -->
    <div id="app-screen">
        <header>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 登出</button>
            <h3><i class="fas fa-tint"></i> 飲水記錄</h3>
            <div style="color:#888; font-size:0.9rem" id="today-date"></div>
        </header>

        <div class="progress-circle">
            <span class="percentage" id="percentage">0%</span>
            <div class="wave" id="wave" style="height: 0%"></div>
        </div>
        
        <div style="text-align:center; margin-bottom:20px;">
            已喝: <strong id="current-val">0</strong> ml / 目標: <strong id="goal-val">2000</strong> ml
        </div>

        <div class="controls">
            <button class="btn btn-add" onclick="addWater(150)">+150</button>
            <button class="btn btn-add" onclick="addWater(250)">+250</button>
            <button class="btn btn-add" onclick="addWater(500)">+500</button>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="number" id="custom-amount" placeholder="自訂 ml" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <button class="btn btn-primary" style="width:auto;" onclick="addCustom()">記錄</button>
        </div>

        <ul class="history-list" id="history-list">
            <!-- 記錄會顯示在這裡 -->
        </ul>
    </div>
</div>

<script>
    // ==========================================
    // 設定區：請在這裡填入你的 Supabase 資訊
    // ==========================================
    const SUPABASE_URL = ' https://fayorxvfxtrycjiiiyfu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZheW9yeHZmeHRyeWNqaWlpeWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzY1MTAsImV4cCI6MjA3OTg1MjUxMH0.7znE_AaNg6zESUO-RoSsyFqxCgcxjPT_pQiN557e6Nw';
    // ==========================================

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let isLoginMode = true;
    let user = null;
    let dailyGoal = 2000;
    let todayRecords = [];

    // 初始化
    init();

    async function init() {
        const { data } = await supabase.auth.getSession();
        if (data.session) {
            user = data.session.user;
            showApp();
        } else {
            showAuth();
        }
    }

    // --- 畫面切換邏輯 ---
    function showAuth() {
        document.getElementById('auth-screen').style.display = 'block';
        document.getElementById('app-screen').style.display = 'none';
    }
    
    async function showApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        
        const dateOpts = { month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('today-date').textContent = new Date().toLocaleDateString('zh-TW', dateOpts);
        
        await loadData();
    }

    function toggleAuth() {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').textContent = isLoginMode ? '會員登入' : '註冊帳號';
        document.getElementById('auth-btn').textContent = isLoginMode ? '登入' : '註冊';
        document.getElementById('auth-toggle').textContent = isLoginMode ? '沒有帳號？去註冊' : '已有帳號？去登入';
        document.getElementById('auth-msg').textContent = '';
    }

    // --- 認證邏輯 ---
    async function handleAuth() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const msg = document.getElementById('auth-msg');
        const btn = document.getElementById('auth-btn');

        if (!email || !password) return msg.textContent = '請填寫完整';
        
        btn.classList.add('loading');
        msg.textContent = '';

        try {
            if (isLoginMode) {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                user = data.user;
                showApp();
            } else {
                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                alert('註冊成功！請直接登入 (如果 Supabase 開啟了信箱驗證，請先去收信)');
                toggleAuth(); // 切換回登入頁
            }
        } catch (err) {
            msg.textContent = err.message.includes('Invalid login') ? '帳號或密碼錯誤' : err.message;
        } finally {
            btn.classList.remove('loading');
        }
    }

    async function logout() {
        await supabase.auth.signOut();
        window.location.reload();
    }

    // --- 資料存取邏輯 ---
    async function loadData() {
        // 1. 讀取目標
        const { data: profile } = await supabase.from('profiles').select('daily_goal').eq('id', user.id).single();
        if (profile) dailyGoal = profile.daily_goal;

        // 2. 讀取今日記錄
        const today = new Date().toISOString().split('T')[0];
        const { data: records, error } = await supabase
            .from('water_records')
            .select('*')
            .eq('user_id', user.id)
            .eq('date', today)
            .order('created_at', { ascending: false });

        if (!error) {
            todayRecords = records;
            updateUI();
        }
    }

    async function addWater(amount) {
        const today = new Date().toISOString().split('T')[0];
        const { error } = await supabase.from('water_records').insert([
            { user_id: user.id, amount: amount, date: today }
        ]);

        if (error) {
            alert('記錄失敗，請檢查網路');
        } else {
            await loadData(); // 重新讀取並更新畫面
        }
    }

    function addCustom() {
        const val = document.getElementById('custom-amount').value;
        if (val > 0) {
            addWater(parseInt(val));
            document.getElementById('custom-amount').value = '';
        }
    }

    async function deleteRecord(id) {
        if (!confirm('確定刪除？')) return;
        await supabase.from('water_records').delete().eq('id', id);
        await loadData();
    }

    // --- UI 更新 ---
    function updateUI() {
        const total = todayRecords.reduce((sum, r) => sum + r.amount, 0);
        document.getElementById('current-val').textContent = total;
        document.getElementById('goal-val').textContent = dailyGoal;

        let pct = Math.round((total / dailyGoal) * 100);
        document.getElementById('percentage').textContent = pct + '%';
        document.getElementById('wave').style.height = Math.min(pct, 100) + '%';

        const list = document.getElementById('history-list');
        list.innerHTML = '';
        todayRecords.forEach(r => {
            const time = new Date(r.created_at).toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
            list.innerHTML += `
                <li>
                    <span><i class="fas fa-glass-water" style="color:#3498db"></i> ${r.amount} ml</span>
                    <span>
                        <span style="color:#999; font-size:0.8rem; margin-right:10px">${time}</span>
                        <i class="fas fa-trash" style="color:#e74c3c; cursor:pointer" onclick="deleteRecord(${r.id})"></i>
                    </span>
                </li>`;
        });
    }
</script>
</body>
</html>
