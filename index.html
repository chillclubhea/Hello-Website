import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';

// 假設您正在使用一個 AI 服務，例如 Google Gemini
const AI_API_KEY = Deno.env.get('AI_API_KEY'); 
const AI_MODEL_ENDPOINT = 'YOUR_AI_MODEL_ENDPOINT'; // 替換成您使用的 AI 模型 API 端點

serve(async (req) => {
    // 驗證請求方法
    if (req.method !== 'POST') {
        return new Response(JSON.stringify({ error: 'Method Not Allowed' }), { status: 405 });
    }

    // 解析請求 Body
    let data;
    try {
        data = await req.json();
    } catch (e) {
        console.error('Failed to parse request body:', e);
        return new Response(JSON.stringify({ error: 'Invalid JSON body' }), { status: 400 });
    }

    const { user_id, messages } = data;
    
    // 檢查關鍵欄位
    if (!user_id || !messages) {
        return new Response(JSON.stringify({ error: 'Missing user_id or message' }), {
            status: 400,
            headers: { 'Content-Type': 'application/json' }
        });
    }

    // 檢查 AI Key
    if (!AI_API_KEY) {
        console.error('AI_API_KEY environment variable not set.');
        return new Response(JSON.stringify({ error: 'AI Service configuration missing.' }), { status: 500 });
    }

    // 這裡替換成您實際的 AI 模型 API 呼叫邏輯
    try {
        // 模擬 AI 響應 (您需要用實際的 fetch 替換這段)
        console.log(`Processing ${messages.length} messages for user: ${user_id}`);
        
        // 這裡應該是調用 AI 服務的代碼
        // const aiResponse = await fetch(AI_MODEL_ENDPOINT, { ... });
        // const result = await aiResponse.json();
        
        // 模擬一個延遲的響應
        await new Promise(r => setTimeout(r, 500)); 
        const aiResponseText = `好的，我收到您的問題了（來自用戶 ID: ${user_id}）。請提供您的詳細問題內容，我會為您提供專業的健康建議。`;
        // 實際應用中，您會從 AI API 的響應中提取文本

        return new Response(JSON.stringify({ 
            response: aiResponseText 
        }), {
            status: 200,
            headers: { 'Content-Type': 'application/json' }
        });

    } catch (e) {
        console.error('AI API Call Failed:', e);
        return new Response(JSON.stringify({ error: 'AI Service request failed.' }), { status: 500 });
    }
});
